<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prescription & Care Plan</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; position: relative; }
    h2, h3 { color: #0b79d0; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    #pdfDownload { display: inline-block; margin-top: 10px; 
                   padding: 10px 15px; background: #28a745; color: #fff;
                   text-decoration: none; border-radius: 4px; }
    .pet-info {
      position: absolute;
      top: 20px;
      right: 20px;
      text-align: right;
      font-size: 12px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .pet-info p { margin: 5px 0; }
  </style>
</head>
<body>
  <div class="pet-info" id="petInfo">
    <!-- Populated dynamically -->
  </div>

  <h2>‚úÖ Your Prescription & Recovery Plan</h2>
 

  <h3>Prescription Schedule</h3>
  <table id="prescriptionTable">
    <thead>
      <tr>
        <th>Date</th><th>Time</th><th>Medicine</th><th>Dosage</th>
        <th>Route</th><th>Duration</th><th>Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Diet & Recovery Plan</h3>
  <table id="dietTable">
    <thead>
      <tr>
        <th>Date</th><th>Feeding Time</th><th>Food Type</th>
        <th>Quantity</th><th>Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Owner-Friendly Explanation</h3>
  <p id="explanation"></p>

  <a id="pdfDownload" href="#" download="prescriptions.pdf">
    üì• Download Full PDF
  </a>

<script>
 async function loadPlan() {
  console.log("‚ñ∂Ô∏è loadPlan() called");
  const record = JSON.parse(localStorage.getItem('latestPetRecord'));
  console.log("üì¶ latestPetRecord:", record);
  if (!record) {
    alert('No saved pet record found.');
    return;
  }

  // 1) Populate Pet Info Box (top-right)
  const petInfo = document.getElementById('petInfo');
  petInfo.innerHTML = `
    <p><strong>Pet Name:</strong> ${record.petName || 'Unnamed'}</p>
    <p><strong>Pet Number:</strong> ${record.petNo || 'Unknown'}</p>
    <p><strong>Disease:</strong> ${record.disease || record.guess || 'Unknown'}</p>
  `;

  // 2) Send to Flask to generate plan + PDF (FIX: Wrap in { petRecord })
  const res = await fetch('/generate_prescription', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ petRecord: record })  // ‚Üê FIXED: Wrapped in { petRecord }
  });
  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    console.error("‚ùå Backend error:", errData);
    alert(`Failed to generate prescription: ${errData.error || 'Unknown error'}`);
    return;
  }
  const data = await res.json();
  console.log("‚úÖ Backend data:", data);

  // 3) Populate Prescription Table
  const pbody = document.querySelector('#prescriptionTable tbody');
  pbody.innerHTML = '';  // Clear any existing
  (data.prescription_plan || []).forEach(row => {
    const tr = document.createElement('tr');
    ['date','time','medicine','dosage','route','duration','notes']
      .forEach(k => {
        const td = document.createElement('td');
        td.textContent = row[k] || '';
        tr.appendChild(td);
      });
    pbody.appendChild(tr);
  });

  // 4) Populate Diet Table
  const dbody = document.querySelector('#dietTable tbody');
  dbody.innerHTML = '';  // Clear any existing
  (data.diet_plan || []).forEach(row => {
    const tr = document.createElement('tr');
    ['date','feeding_time','food_type','quantity','notes']
      .forEach(k => {
        const td = document.createElement('td');
        td.textContent = row[k] || '';
        tr.appendChild(td);
      });
    dbody.appendChild(tr);
  });

  // 5) Owner Explanation
  document.getElementById('explanation').textContent = data.explanation || 'No explanation available.';

  // 6) PDF link
  const pdfLink = document.getElementById('pdfDownload');
  if (data.pdf_url) {
    pdfLink.href = data.pdf_url;
    pdfLink.style.display = 'inline-block';
  } else {
    pdfLink.style.display = 'none';
    console.warn("‚ö†Ô∏è No PDF URL returned");
  }
 }

 document.addEventListener('DOMContentLoaded', loadPlan);
</script>
</body>
</html>